---
title: "Homework 4"
author: "Group 1"
date: ''
output:
  pdf_document:
    includes:
      in_header: header.tex
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    toc: yes
    toc_depth: '2'
---

```{r programming style guide, echo=FALSE, eval=FALSE}
##Style guide
##USE CAMEL CASING!! https://en.wikipedia.org/wiki/Camel_case, start with lowercase then each word after start with upper case
##upper case for vector, lists, etc. ex. X <- c("yes","no","true","false")
##lower case for scalar/single value, ex. x <- 1
##data frame start with df followed by description, ex. dfEval <- evaluation data frame
##assignments use "<-" not "="
```

```{r library load, include = FALSE}
library(pacman)
p_load(Hmisc, xlsx, xtable, knitr, scales, magrittr, tidyverse, stringr, e1071, corrplot, knitcitations, bibtex, missForest, abc, foreach, doParallel, stargazer, forecast, matrixStats, glmulti, leaps, data.table, highlight, car)
```

\begin{center}
\bigskip
\bigskip
\bigskip
Prepared for:\\
\medskip
Dr. Nathan Bastian\\
\smallskip
City University of New York, School of Professional Studies - Data 621\\
\bigskip
Prepared by:\\
\medskip
Group 1\\ 
\medskip
Senthil Dhanapal\\ 
\smallskip
Yadu Chittampalli\\
\smallskip
Christophe Hunt\\  

\end{center}

\newpage

# Introduction

Consumers who own a car are often required to purchase car insurance to protect themselves from serious financial repercussions of being involved in a car accident. Insurance Providers must determine the risk of offering insurance coverage to a new customer through accurate statistical models that evaluate the consumers propensity for accidents. Since Insurance Providers are motivated by collecting the maximum amount of revenue from consumers while returning the lowest amount in accident claims, statistical modeling provides Insurance Providers with insight into the consumers behavior and the most appropriate pricing schemes[^1]. 

[^1]: ["Insider Information: How Insurance Companies Measure Risk - Insurance Companies.com."](http://www.insurancecompanies.com/insider-information-how-insurance-companies-measure-risk/) Insurance Companiescom. N.p., n.d. Web. 06 Nov. 2016.

# Statement of the Problem

The purpose of this report is to develop statistical models to make inference into the likelihood of a customer being involved in a car accident and the cost associated of a customer being involved in a car accident. 

# Data Exploration  

## Variables Explained

The variables provided in the `Insurance Training Data Set` are explained below:

```{r data dictionary load, include=FALSE, cache=TRUE}
download.file("https://github.com/ChristopheHunt/DATA-621-Group-1/raw/master/Homework%204/Data%20Dictionary.xlsx?raw=true", destfile = "Data Dictionary HW4 - Group 1.xlsx", mode = 'wb')
daDict <- read.xlsx("Data Dictionary HW4 - Group 1.xlsx", sheetIndex = 1)
file.remove(dir(getwd(), pattern = "Data Dictionary HW4 - Group 1", full.names = TRUE))
```
\footnotesize
```{r data dictionary table, eval=TRUE, results='asis', echo=FALSE}
kable(daDict %>% 
      mutate(`Variable Code` = VARIABLE.NAME, Definition = DEFINITION)  %>%
      dplyr::select(`Variable Code`, Definition),
      align = c("c","l"))
```


```{r data prep, echo=FALSE, results='asis'}
dfTr <- read.csv("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Homework%204/insurance_training_data.csv")

removeDollars <- function(column){
             as.numeric(gsub("\\,","",gsub("\\$","", column)))
            }

dfTr$JOB <- as.character(dfTr$JOB)
dfTr$JOB[(dfTr$JOB == "")] <- NA

dfTr <- dfTr %>%
        mutate(INCOME = removeDollars(INCOME),
               HOME_VAL = removeDollars(HOME_VAL),
               BLUEBOOK = removeDollars(BLUEBOOK),
               OLDCLAIM = removeDollars(OLDCLAIM),
               MSTATUS = as.factor(gsub("z_", "", MSTATUS)),
               SEX = as.factor(gsub("z_", "", SEX)),
               EDUCATION = factor((gsub("<", "Less Than ", gsub("z_", "", EDUCATION))), 
                                  levels = c("Less Than High School", "High School", "Bachelors", "Masters", "PhD")),
               JOB = as.factor(gsub("z_", "", JOB)),
               CAR_TYPE = as.factor(gsub("z_", "", CAR_TYPE)),
               URBANICITY = as.factor(gsub("z_", "", URBANICITY)))

```
\normalsize

\newpage

### Nominal Variables

We first look at our nominal variables and their applicable proportions. Interestingly, we see that in this data set only a quarter of the customer records indicate an accident occurred. Also, the majority of consumers in this data set have no kids at home, are married, more than a high school education but less than a PhD, use their car for private purposes, typically own a SUV or minivan, and also live in an urban environment. This provides an interesting insight to the type of customer this data set represents and should be considered when further interpreting our statistical model. Additionally, we should be mindful of any selection biases in this data set as consumers with extremely risky histories are likely to have not been extended insurance coverage. 

```{r nominal variables, echo=FALSE, results='asis', cache=TRUE}
options(xtable.comment = FALSE)

reporttools::tableNominal(dfTr %>% 
                        dplyr::select(TARGET_FLAG, KIDSDRIV, HOMEKIDS, PARENT1, MSTATUS, SEX, 
                                      EDUCATION, JOB, CAR_USE,  CAR_TYPE,RED_CAR, CLM_FREQ, REVOKED, URBANICITY), 
                        cap = "Table of nominal variables", lab = "tab: nominal", print.pval = "fisher",
                        caption.placement = "top", longtable = TRUE, 
                        add.to.row = list(pos = list(0), command = "\\hline \\endhead "))
```

### Continuous and Discrete Variables

We can see that in our continuous and discrete variables there is some additional variability. The median claim amount (`TARGET_AMT`) is 0 which would coincide with only a quarter for records indicating an accident. However, the spread is large since the average payout is only \$1,504.30 but the maximum payout was \$107,586.10. Surprisingly, the median `AGE` is 45 and the average `AGE` is 44.8 years, while we expected a lower average it could be due to simple selection bias in the data set source or the aging US population bringing this average higher [^3]. We also noticed that an `INCOME` of \$0.00 seems unwise because it is unclear how the individual would be able to cover their premium costs without parental support. Finally, we should note that the data set has as `CAR_AGE` of -3, which is impossible and will need to be removed.

There are many missing values for this portion of our data set, we have over 400 values missing for years on the job, income, home value, and car age. Due to these missing values we will need to impute to complete our statistical model. 

[^3]: Ortman, Jennifer M., Victoria A. Velkoff, and Howard Hogan. "An aging nation: the older population in the United States." Washington, DC: US Census Bureau (2014): 25-1140.

```{r continous variables, echo=FALSE, results='asis', cache=TRUE}
reporttools::tableContinuous(dfTr %>% 
                               dplyr::select(TARGET_AMT, TIF, AGE, YOJ, INCOME, HOME_VAL,
                                             TRAVTIME, BLUEBOOK, OLDCLAIM, MVR_PTS, CAR_AGE), 
                             longtable = TRUE)
```

\newpage

## Imputting Missing Values

In order to address the missing values in our variables we used a non-parametric imputation method (Random Forest) using the `missForest` package. The function is particularly useful in that it can handle any type of input data and it will make as few assumptions about the structure of the data as possible.[^2]

[^2]: Stekhoven, Daniel J., and Peter Bühlmann. ["MissForest-non-parametric missing value imputation for mixed-type data." Bioinformatics 28.1 (2012): 112-118](http://bioinformatics.oxfordjournals.org/content/28/1/112.short).

```{r, results='asis', echo = FALSE, include=FALSE, cache=TRUE, eval=FALSE}
registerDoParallel(cl = makeCluster(10), cores = 2)

set.seed(1234)

dfTr$CAR_AGE[(dfTr$CAR_AGE == -3)] <- NA

imputed_data <- dfTr %>% missForest(maxiter = 10, ntree = 100, replace = TRUE, parallelize = 'forests', verbose = TRUE) #Takes approximately 1 hour to process

write.csv(imputed_data$ximp,"imputed_insurance_training_data.csv", row.names = FALSE) #wrote imputed_data to csv file due to processing time taken by missForest
```

```{r, results='asis', echo = FALSE, cache=TRUE, eval=TRUE}
imputedDfTr <- read.csv("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Homework%204/imputed_insurance_training_data.csv")

descriptive <- describe(imputedDfTr %>% dplyr::select(-INDEX),
                        descript = "Table 2 : Imputed Descriptive Statistics", 
                        digits = digits)

latex(descriptive, file = '')
```

## Exploration of Variables

```{r correlation matrix, fig.cap= "Correlation Plot of Training Data Set", echo = FALSE, fig.height = 3, fig.width= 8, cache=TRUE, eval=TRUE}

imputedDfTrMx <- imputedDfTr %>%
                   mutate(Yes = 1) %>%
                   spread(EDUCATION, Yes, fill = 0) %>%
                   mutate(Yes = 1) %>%
                   spread(JOB, Yes, fill = 0) %>%
                   mutate(Yes = 1) %>%
                   spread(CAR_TYPE, Yes, fill = 0) %>%
                   mutate(Yes = 1) %>%
                   mutate(SEX = ifelse(SEX == "F", "Female", "Male")) %>%
                   spread(SEX, Yes, fill = 0) %>%
                   mutate(Yes = 1) %>%
                   mutate(CAR_USE = ifelse(CAR_USE == "Commercial", "Commercial Car Use", "Private Car Use")) %>%
                   spread(CAR_USE, Yes, fill = 0) %>%
                   mutate(Yes = 1) %>%
                   spread(URBANICITY, Yes, fill = 0 ) %>%
                   mutate(PARENT1 = ifelse(PARENT1 == "No", 0, 1),
                          MSTATUS = ifelse(MSTATUS == "No", 0, 1),
                          RED_CAR = ifelse(RED_CAR == "no", 0, 1),
                          REVOKED = ifelse(REVOKED == "No", 0, 1))

imputedDfTrMx <- as.matrix(imputedDfTrMx)

corMx <- cor(imputedDfTrMx , use = "everything",  method = c("pearson"))
corrplot(corMx, order = "hclust", addrect = 2, method = "square", tl.col = "black", tl.cex = .75, na.label = " ")
```


