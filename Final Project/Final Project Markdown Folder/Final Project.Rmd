---
title: Regional Liquor Sales in Des Moines, Iowa
author:
  - name: Christophe Hunt
    email: christophe.hunt@spsmail.cuny.edu
    affiliation: CUNY School of Professional Studies
    footnote: Authors
  - name: Senthil Dhanapal
    email: senthil.dhanapal@spsmail.cuny.edu
    affiliation: CUNY School of Professional Studies
  - name: Yadu Chittampalli
    email: yadu.chittampalli@spsmail.cuny.edu
    affiliation: CUNY School of Professional Studies
address:
  - code: CUNY School of Professional Studies
    address: CUNY School of Professional Studies, Data Analytics, New York, NY
abstract: |
  This is the abstract.

  It consists of two paragraphs
  
  #Keywords:  Liquor Sales, Naive Forecast*

bibliography: mybibfile.bib
output: rticles::elsevier_article
---

```{r programming style guide, echo=FALSE, eval=FALSE}
##Style guide
##USE CAMEL CASING!! https://en.wikipedia.org/wiki/Camel_case, start with lowercase then each word after start with upper case
##upper case for vector, lists, etc. ex. X <- c("yes","no","true","false")
##lower case for scalar/single value, ex. x <- 1
##data frame start with df followed by description, ex. dfEval <- evaluation data frame
##assignments use "<-" not "="
```

```{r options and library load, include = FALSE}
options(xtable.comment = FALSE)
library(pacman)
p_load(ggplot2, fitdistrplus, logspline, pander, Hmisc, tidyverse)
```

Problem
=================

The objective of this report is to create a statistical model for the volume sold of liquor in gallons and the profit margin in the City of Des Moines which is within the state of Iowa. This will help us make informed decisions on inventory production, sales, and assist wholesale distributors to plan for the predicted volume of distribution.  

Introduction
=================

In February, the Distilled Spirits Council (DISCUS), announced that spirits had an estimated retail sales of nearly $72 billion in 2015. Additionally, DISCUS credits the continuous growth of the distilled spirits industry to several key factors - continuous fascination with American Whiskeys in the United States and abroad, innovations in flavors, permutation across all spirits categories leading to consumer interest, improved regulatory and tax environment resulting in expanded market access and a relatively low number of state tax threats, and the growth of small distillers, which expanded grassroots and overall interest in the spirits category @KeepingSpiritsHigh1. 

This establishes that spirit sales in the Unites States is a valuable market worth exploring for a more detailed and statistical understanding of sales and volume. We hope to more thoroughly understand what impact specific store sights may have accounting for the seasonal impact in November that might effect liquor sales. We will limit the analysis to the City of Des Moines for only whisky sales in the month of November. In 2000 the State of Iowa reported sales at a record pace during the last half of 2000 @IowaSetsRecord2. The later part of the year has an increase in sales so planning to meet capacity is a suitable goal for any company. Our years of interest for this analysis will be the month of November for 2015 and 2016.

Research Background (Literature Review)
=================

Our goal is inventory prediction. 

Methodology
================

The initial data set contained many variables and is sufficiently large as it includes sales by location and each individual invoice since 2012. The reason for the large size of the initial data set is due to it including every liquor transaction from 2012 to present in Iowa, so it approaches 2.68 GB. For the purposes of this analysis, to analyze a data set this large is not feasible. Therefore, we reduced the number of variables and summarized to a regional aggregate.

Additionally, we looked into the top 10 liquor categories for each year by number of bottles sold. In 2015, the top categories were American Cocktails, Blended Whiskies, Canadian Whiskies, Imported Vodka, Puerto Rico & Virgin Islands Rum, Spiced Rum, Straight Bourbon Whiskies, Tequila, Vodka 80 Proof, and Whiskey Liqueur. Interestingly straight bourbon appears to have more sales in 2015 than 2014 which coincides with the literature of strong growing whiskey sales for every whiskey segment (@SpecialityGrow3). We decided to focus on whiskey do to its strong sales and growing interest in the US.

Furthermore, 

So we reduced the data set to a subset of variables as follows; `Vendor Name`, `Pack` (pack size of bottles sold) `Bottle Volume`, `State Bottle Cost`, `State Bottle Retail`, `Sales Dollars` (Total sales), and our dependent variables are `Volume sold in Gallons` and `Profit Dollars`.

We initially attempted to model for a dependent variable of `Volume Sold in Gallons` by `County`, however, the distribution of this variable becomes over-dispersed and negatively skewed when aggregating the data set to a manageable size and therefore we were unsuccessful in modeling this variable across regions. Our hope was that if we could model for the gallons sold by region we could more accurately predict our planned inventory and anticipate production goals. We were more successful in limiting our regional analysis to one city and the stores within that city. 


In Des Moines in Iowa, we want to predict bottles sold of whiskey (as a whiskey company) in the holiday month of November, 
the stores (storeID) and we have Vendor Name, Pack (in case pack size influences sales), bottle volume (people looking for deals) 
state bottle cost (how much to procure), state bottle retail (how much we sell for), Sale Dollars (total sales) 
Volume (gallons), profit margin (calculate for the business problem).


We then sought to model the mean price per bottle, by modeling the price per bottle we can make pricing decisions based on region and the volume we plan to sell. 


discuss the key aspects of your problem, data set and regression model(s). Given that you are working on real-world data, explain at a high-level your exploratory data analysis, how you prepared the data for regression modeling, your process for building regression models, and your model selection.

Experimentation and Results
=============================

```{r , echo = FALSE, results='asis', warning = FALSE, message = FALSE , cache=TRUE, eval=FALSE}
library(data.table)
library(tidyverse)

iowa_data <- fread("~.\Iowa_Liquor_Sales.csv", header = T, sep = ',')

removeDollars <- function(column){
  as.numeric(gsub("\\,","",gsub("\\$","", column)))
}

iowa_data_reduced <- iowa_data %>%
                     dplyr::select(Date, City, `Category Name`, `Store Number`, `Store Name`, `Pack`, 
                            `Item Number`, `Item Description`, `Bottle Volume (ml)`, 
                            `State Bottle Cost`, `State Bottle Retail`, `Sale (Dollars)`,
                             `Volume Sold (Gallons)`, `Bottles Sold`) %>%
                    mutate(Date = as.Date(Date, format = "%m/%d/%Y"),
                           City = factor(toupper(City)),
                           `Category Name` = factor( toupper(`Category Name`)),
                           `Store Number` = factor(`Store Number`),
                           `Store Name` = factor(`Store Name`), 
                           `Pack` = as.integer(`Pack`),
                           `Bottle Volume (ml)` = as.numeric(`Bottle Volume (ml)`), 
                           `State Bottle Cost` = removeDollars(`State Bottle Cost`), 
                           `State Bottle Retail` = removeDollars(`State Bottle Retail`), 
                           `Sale (Dollars)` = removeDollars(`Sale (Dollars)`),
                           `Volume Sold (Gallons)` = as.numeric(`Volume Sold (Gallons)`), 
                           `Bottles Sold` = as.integer(`Bottles Sold`)) %>%
                    mutate(Month = format(Date, "%m"),
                           Year = format(Date, "%Y")) %>%
                    dplyr::filter(Month == "11") %>%
                    dplyr::filter(Year == "2015") %>% 
                    dplyr::filter(City == "DES MOINES") %>% 
                    dplyr::filter(grepl("WHISKIES", `Category Name`)) %>%
                    dplyr::select(-Date) %>%
                    group_by(Month, Year, City, `Category Name`, `Store Number`, `Store Name`)  %>%
                    summarize( `Pack` = mean(`Pack`),
                               `Bottles Sold` = sum(`Bottles Sold`), 
                               `Sale (Dollars)` = sum(`Sale (Dollars)`), 
                               `Bottle Volume (ml)` = mean(`Bottle Volume (ml)`),
                               `State Bottle Cost` = sum(`State Bottle Cost`),
                               `State Bottle Retail` = sum(`State Bottle Retail`),
                               `Sale (Dollars)` = sum(`Sale (Dollars)`),
                               `Volume Sold (Gallons)` = sum(`Volume Sold (Gallons)`)) %>%
                    as_tibble()

iowa_data_reduced <- iowa_data_reduced %>%
                    dplyr::ungroup() %>%
                    mutate(Month = as.numeric(Month),
                           Year = as.numeric(Year),
                           `Category Name`= factor(`Category Name`)) %>%
                    arrange(Year, Month, County, City)

write.csv(iowa_data_reduced, "iowa_data_reduced.csv")
```


# Model 1 

```{r data read for model, echo = FALSE, cache=TRUE}
dfLiquorSales <- read.csv("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Final%20Project/iowa_data_reduced%2012.10.2016.csv") %>% mutate(Store.Number = factor(Store.Number))
```


#Forward step 
```{r forward step selection for model, echo = FALSE, cache=TRUE} 
step(lm(Bottles.Sold~1,data=dfLiquorSales),direction = "forward",
     scope=~Category.Name+Store.Number+Pack+Sale..Dollars.+Bottle.Volume..ml.
     +State.Bottle.Cost+State.Bottle.Retail+Volume.Sold..Gallons.)

#step(lm(target~zn+indus+chas+nox+rm+age+dis+rad+tax+ptratio+black+lstat+medv,data=df),direction = "backward")
```

```{r}
fit1 <- lm(formula = Bottles.Sold ~ Volume.Sold..Gallons. + Category.Name + 
     State.Bottle.Retail + Pack + Sale..Dollars., data = dfLiquorSales)
```


#Volume.Sold..Gallons=One unit of increase in volume sold will increase the bottles sold by 4.10 units

#Category.Name
# CANADIAN WHISKIES is the only one that is significant. 
# CANDIAN WHISKIES vs BLENDED WHISKIES coefficient is 5.492

#State.Bottle.Retail=One unit of increase in State.Bottle.Retail will increase the bottles sold by 7.133 units
#Pack=One unit of increase in Pack will increase the bottles sold by 7.133 units
#Sale..Dollars.=It is slightly significant. One unit of increase in Sale..Dollars. will decrease the bottles sold by 2.189 units

#Formula = -4.196 + 25.314*Volume.Sold..Gallons. + 5.492 * (Category.Name="CANADIAN WHISKIES" ) + 
#       7.133 * (State.Bottle.Retail) + 7.521 * (Pack) - 2.189 * Sale..Dollars. 


Data Acquisition
============================

The data set contains the spirits purchase information of Iowa Class "E" liquor licensees by product and date of purchase from January 1, 2012 to current. The data set is provided by the Iowa Department of Commerce, Alcoholic Beverages Division, [click here](https://data.iowa.gov/Economy/Iowa-Liquor-Sales/m3tr-qhgy) to view the data set at Data.Iowa.Gov.

As discussed in our methodogly section, the data set is 2.68 GB in total size and much to large to process with our current techiniques. A greater understanding of working with data sets of this size with R w

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE}
iowaDataReduced <- read.csv("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Final%20Project/iowa_data_reduced.csv") 
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE}
library(magrittr)
library(dplyr)

iowaDataReducedTop <- iowaDataReduced %>%
                      dplyr::group_by(Year, Category.Name) %>%
                      dplyr::select(Year, Category.Name, Volume.Sold..Gallons. ) %>%
                      dplyr::summarize(Volume.Sold..Gallons. = round(sum(Volume.Sold..Gallons.))) %>%
                      dplyr::top_n(n = 10, wt = Volume.Sold..Gallons.)

top10in2015 <- iowaDataReducedTop %>%
               dplyr::filter(Year == 2015)

top20counties <- iowaDataReduced %>%
                  dplyr::filter(Year == 2015) %>% 
                      dplyr::group_by(Year, County) %>%
                      dplyr::select(Year, Category.Name, Volume.Sold..Gallons. ) %>%
                      dplyr::summarize(Volume.Sold..Gallons. = sum(Volume.Sold..Gallons.)) %>%
                      top_n(n = 20, wt = Volume.Sold..Gallons.)
```


```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE}
library(magrittr)
iowaDataReduced <- iowaDataReduced %>%
                   filter(Year == 2015) %>%
                   dplyr::select(County, Category.Name, 
                                 Bottles.Sold, Sale..Dollars., Volume.Sold..Gallons.) %>%
                  mutate(`Price per Bottle` = Sale..Dollars./Bottles.Sold) %>%
                   dplyr::group_by(County, Category.Name) %>%
                   dplyr::summarize(`Bottles Sold` = sum(Bottles.Sold), 
                             `Avg Price Per Bottle` = mean(`Price per Bottle`),
                             `Sales in Dollars` = sum(Sale..Dollars.), 
                             `Volume Sold by Gallons` = sum(Volume.Sold..Gallons.)) %>%
                  filter(County != "") %>%
                  filter(Category.Name %in% top10in2015$Category.Name) %>%
                  filter(County %in% top20counties$County)

write.csv(iowaDataReduced, "iowa_data_reduced.csv")
```

We reviewed the liquor sales by gallons sold per year by Liquor Category. Initially, we viewed the top 5 Liquor Categories by volume sold but there were large disparate between years, suggesting that the top 5 change often and likely due to changing consumer tastes. We do see a more stable set of liquor categories for the top 10 category which suggests that while tastes may change we don't see large movements in liquor categories. For this analysis we will focus on the whiskey categories.  

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=6, fig.width=10, eval=TRUE}
ggplot(iowaDataReducedTop, aes(x = Category.Name, y = Volume.Sold..Gallons., fill = factor(Year))) + 
      scale_y_continuous(labels = scales::comma) + 
      geom_bar(stat = "identity") +
      facet_grid(~Year) +
      theme(axis.text.x = element_text(angle = 70, hjust = 1), legend.position = "none") +
      xlab("Liquor Category") + 
      ylab("Volume Sold by Gallons\n") +
      ggtitle("                                        Volume of Liquor Category Sales by Gallons Sold")
```

Our first attempt was to  use a Poisson regression due to the over-dispersion created by aggregating the data set. However, the distribution was far to negatively skewed to fit a poission distribution. We therefore chose  

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=6, fig.width=10, eval=TRUE}
x <- descdist(iowaDataReduced$`Avg Price Per Bottle`, discrete = FALSE, boot = 100)
pandoc.table(x)
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=6, fig.width=10, eval=TRUE}
fit.norm <- fitdist(iowaDataReduced$`Avg Price Per Bottle`, "norm")
plot(fit.norm)
```

```{r, results='asis', echo=FALSE}
describedData <- describe(dfLiquorSales)
latex(describedData, file = '')
describe(dfLiquorSales$Store.Number)
describe(dfLiquorSales$Category.Name)
```

describe the specifics of what you did (data exploration, data preparation,
model building, model selection, model evaluation, etc.), and what you found out (statistical analyses,
interpretation and discussion of the results, etc.).

Discussion and Conclusions
============================

In another study conducted in 2012 in Idaho, the monthly revenue generated was examined rather than the yearly revenue generated. The continued growth was rather owed to the number of weekends a month has (five instead of four) and to the higher prices in neighboring states. In Washington, the voters approved an initiative that led the state to sell its liquor stores and add new distributor and retail fees, making prices in the neighboring states (Idaho and Oregon) look better. There were no changes made in marketing or pricing in response to the regulatory shift in Washington @IdahoSales4. Further research into the proximity of our counties to states and towns with higher prices and regulation may provide more insight into sales and volume of liquor sold. Additionally, reviewing the data by identifying months that has 5 weekends instead of four could provide further insights. 

conclude your findings, limitations, and suggest areas for future work.

\newpage

Appendices
=============

# Supplemental tables and/or figures.

# Session Info

```{r, results='asis', echo=FALSE, eval = TRUE}
toLatex(sessionInfo())
```

# R statistical programming code.

Please see [Final Project.rmd](https://github.com/ChristopheHunt/DATA-621-Group-1/blob/master/Final%20Project/Final%20Project.Rmd) on GitHub for source code.   

https://github.com/ChristopheHunt/DATA-621-Group-1/blob/master/Final%20Project/Final%20Project.Rmd

References {#references .unnumbered}
===============
