---
title: Regional Liquor Sales in Des Moines, Iowa
author:
  - name: Christophe Hunt
    email: christophe.hunt@spsmail.cuny.edu
    affiliation: CUNY School of Professional Studies
    footnote: Authors
  - name: Senthil Dhanapal
    email: senthil.dhanapal@spsmail.cuny.edu
    affiliation: CUNY School of Professional Studies
  - name: Yadu Chittampalli
    email: yadu.chittampalli@spsmail.cuny.edu
    affiliation: CUNY School of Professional Studies
address:
  - code: CUNY School of Professional Studies
    address: CUNY School of Professional Studies, Data Analytics, New York, NY
abstract: | 

          The forward stepwise selection method was used in conjunction with linear regression which was applied to predict the bottles sold and the profit incurred. The dataset used consisted of data regarding sales of liquor from different stores in different counties within the state of Iowa. Due to its large size, the dataset was subsetted to only include data pertaining to whiskies sold in Des Moines in the month of November, 2015. Before outputting the models, the influential points were all removed. For each target variable, two models were rendered. In the first and third models, the only variable that showed significance was Canadian Whiskies. This variable increases the bottles sold and the profit respectively by factors of 30.67 and 27.88. 

          In the second model and fourth models, the target variable was logarithmically transformed to a more normal distribution. In the second model, the variables that were highly significant were Canadian Whiskies, Scotch, Irish, State Bottle Retail, Pack, and Volume Sold. Canadian Whiskies, State Bottle Retail, Pack, and Volume Sold increase the logarithm of Bottles Sold respectively by factors of 0.626, 0.003, 0.058, and 0.008. Scotch and Irish will both decrease the logarithm of Bottles Sold respectively by factors of 0.6 and 0.76. In the fourth model, the variables that were highly significant were Volume Sold, all of the Whiskies, and Sale Dollars. All of these significant variables increase the logarithm except Sale Dollars. Sale Dollars decreases the logarithm of Profit by a factor of 0.0002.  

  #Keywords:  Liquor Sales, Naive Forecast, Linear Regression, Inventory Forecast*

bibliography: mybibfile.bib
output: rticles::elsevier_article
---

```{r programming style guide, echo=FALSE, eval=FALSE}
##Style guide
##USE CAMEL CASING!! https://en.wikipedia.org/wiki/Camel_case, start with lowercase then each word after start with upper case
##upper case for vector, lists, etc. ex. X <- c("yes","no","true","false")
##lower case for scalar/single value, ex. x <- 1
##data frame start with df followed by description, ex. dfEval <- evaluation data frame
##assignments use "<-" not "="
```

```{r options and library load, include = FALSE}
old.par <- par(mar = c(0, 0, 0, 0))
options(xtable.comment = FALSE)
library(pacman)
p_load(ggplot2, fitdistrplus, logspline, pander, Hmisc, tidyverse, stargazer, data.table, RColorBrewer, forecast, car, knitr)
```

Problem
=================

The objective of this report is to create a statistical model for the number of bottles sold of whiskey and the profit dollars in the City of Des Moines which is within the state of Iowa. This can help us make informed decisions on inventory prediction, sales, and assist wholesale distributors to plan for the predicted volume of distribution.  

Introduction
=================

In February, the Distilled Spirits Council (DISCUS), announced that spirits had an estimated retail sales of nearly $72 billion in 2015. Additionally, DISCUS credits the continuous growth of the distilled spirits industry to several key factors - continuous fascination with American Whiskeys in the United States and abroad, innovations in flavors, permutation across all spirits categories leading to consumer interest, improved regulatory and tax environment resulting in expanded market access and a relatively low number of state tax threats, and the growth of small distillers, which expanded grassroots and overall interest in the spirits category (@KeepingSpiritsHigh1). 

This establishes that spirit sales in the Unites States is a valuable market worth exploring for a more detailed and statistical understanding of sales and volume. We hope to more thoroughly understand what impact specific store sights may have accounting for the seasonal impact in November that might effect liquor sales. We will limit the analysis to the City of Des Moines for only whiskey sales in the month of November. In 2000 the State of Iowa reported sales at a record pace during the last half of 2000 (@IowaSetsRecord2). The later part of the year has an increase in sales so planning to meet capacity is a suitable goal for any company. Our time of interest for this analysis will be the month of November for 2015.

Research Background
=================

The main goal that has to be achieved in inventory prediction is increasing the efficiency without decreasing the service value offered to the customers. When managing the levels of inventory, it is important to maintain moderate level(s) - not too high and not too low. If the inventory level is excessive, business funds can get wasted. These funds would not be able to be used for any other purpose, thus involving an opportunity cost. The costs of shortage, handling insurance, recording and inspection would proportionately increase along with inventory volume, thus impairing profitability. 

On the other hand, low level(s) of inventory may result in frequent interruptions in the production schedule resulting in under-utilization of capacity and lower sales.  When making predictions about orders that should be placed, assumptions are made as follows - uncertainty always exists regardless of the method(s) used, new technologies cannot always be forecasted for which paradigms do not exist, and social policy will be formulated where the future would be affected, changing the accuracy of the forecast (@Forecast1). 

One useful method for predicting inventories is the extrapolation of trends. In this method, trends and cycles in the historical data are examined and mathematical techniques are used to extrapolate to the future. The model chosen for forecasting would depend on the historical data (@Forecast1). 

One of the most common models used in this method is decomposition, where historical data is separated into trend, seasonal, and random components. As a result, forecasts are produced using "turning point analysis". Other examples of models used are adaptive filtering, Box-Jenkins analysis, simple linear regression, curve fitting, and weighted smoothing (@Forecast1). 

According to Makridakis, "Judgmental forecasting is superior to mathematical models, although there are several forecasting applications where computer-generated models would be more feasible." When inventory levels for bulk-quantity items would need to be forecasted monthly by large manufacturing companies, generating models through computer software would be more efficient (@Forecast1). 

Forecasting the demand of a product is very essential in predicting the order quantity. As a result, a data bank is created, helping the decision makers settle targets, create plans, and demonstrate changes in the business setting. 

Two different methods are utilized in the investigation of the future demand - quantitative and qualitative. In quantitative methods, mathematical consistencies in the history are searched for. Two subcategories exist in quantitative methods - time series models and correlation models. On the other hand, qualitative methods are based on the opinions that people have had about the product in the past based on their experiences, premonitions, and emotions (@Demand1). 

However, when the most suitable forecast model gets selected, it is not necessarily based solely on quantitative or qualitative variables. The forecast model can even combine several models (@Demand1). 

Methodology
================

Our initial data set is sufficiently large in that it includes sales by individual stores and the invoices for each store. The reason for the large size of the initial data set is due to it including every liquor transaction from 2012 to present in Iowa, so it approaches 2.68 GB. For the purposes of this analysis, to analyze a data set this large is not feasible. Therefore, we reduced the number of variables and summarized to a regional aggregate.

Additionally, we looked into the top 10 liquor categories for each year by number of bottles sold. In 2015, the top categories were American Cocktails, Blended Whiskies, Canadian Whiskies, Imported Vodka, Puerto Rico & Virgin Islands Rum, Spiced Rum, Straight Bourbon Whiskies, Tequila, Vodka 80 Proof, and Whiskey Liqueur. Interestingly straight bourbon appears to have more sales in 2015 than 2014 which coincides with the literature of strong growing whiskey sales for every whiskey segment (@SpecialityGrow3). We decided to focus on whiskey do to its strong sales and growing interest in the US.

We accomplished this by looking into volume of sales by the largest `County` for Iowa which is Polk county. The City of Des Moines has the largest volume of whiskey sales in Polk county so we limited our analysis to this city. 

Therefore, our final evaluation data set is the following subset of variables for largest city in Iowa of Des Moines as follows; `Vendor Name`, `Pack` (pack size of bottles sold) `Bottle Volume`, `State Bottle Cost`, `State Bottle Retail`, `Sales Dollars` (Total sales), and our dependent variables are `Volume sold in Gallons` and `Profit Dollars`. 

By modeling `Bottles Sold` and `Profit Dollars` we aim to predict the volume of production needed and the possible profit dollars when producing at the predicted volume. We first began by using linear regression to model both the Bottles Sold and Profit Dollars, however, the distributions of the residuals were initially non-normal for both. So we used the BoxCox method to transform both dependent variables to a more normal distribution. We then used forward selection method to determine the final form for the model of Bottles Sold and Profit Dollars. We further removed points that had unusually high influence on the model. We used the AIC of each model to make our final selection for both dependent variable models. 

Experimentation and Results
=============================

### Data Acquisition

The data set contains the spirits purchase information of Iowa Class "E" liquor licensees by product and date of purchase from January 1, 2012 to current. The data set is provided by the Iowa Department of Commerce, Alcoholic Beverages Division, [click here](https://data.iowa.gov/Economy/Iowa-Liquor-Sales/m3tr-qhgy) to view the data set at Data.Iowa.Gov.

As previously discussed, the data set is 2.68 GB in total size and much to large to use in a meaningful model.

```{r , echo = FALSE, results='asis', warning = FALSE, message = FALSE , cache=TRUE, eval=FALSE}
library(data.table)
library(tidyverse)

iowa_data <- fread("~./Iowa_Liquor_Sales.csv", header = T, sep = ',')

removeDollars <- function(column){
  as.numeric(gsub("\\,","",gsub("\\$","", column)))
}

iowa_data_reduced <- iowa_data %>%
                     dplyr::select(Date, City, `Category Name`, `Store Number`, `Store Name`, `Pack`, 
                            `Item Number`, `Item Description`, `Bottle Volume (ml)`, 
                            `State Bottle Cost`, `State Bottle Retail`, `Sale (Dollars)`,
                             `Volume Sold (Gallons)`, `Bottles Sold`) %>%
                    mutate(Date = as.Date(Date, format = "%m/%d/%Y"),
                           City = factor(toupper(City)),
                           `Category Name` = factor( toupper(`Category Name`)),
                           `Store Number` = factor(`Store Number`),
                           `Store Name` = factor(`Store Name`), 
                           `Pack` = as.integer(`Pack`),
                           `Bottle Volume (ml)` = as.numeric(`Bottle Volume (ml)`), 
                           `State Bottle Cost` = removeDollars(`State Bottle Cost`), 
                           `State Bottle Retail` = removeDollars(`State Bottle Retail`), 
                           `Sale (Dollars)` = removeDollars(`Sale (Dollars)`),
                           `Volume Sold (Gallons)` = as.numeric(`Volume Sold (Gallons)`), 
                           `Bottles Sold` = as.integer(`Bottles Sold`)) %>%
                    mutate(Month = format(Date, "%m"),
                           Year = format(Date, "%Y")) %>%
                    dplyr::filter(Month == "11") %>%
                    dplyr::filter(Year == "2015") %>% 
                    dplyr::filter(City == "DES MOINES") %>% 
                    dplyr::filter(grepl("WHISKIES", `Category Name`)) %>%
                    dplyr::select(-Date) %>%
                    group_by(Month, Year, City, `Category Name`, `Store Number`, `Store Name`)  %>%
                    summarize( `Pack` = mean(`Pack`),
                               `Bottles Sold` = sum(`Bottles Sold`), 
                               `Sale (Dollars)` = sum(`Sale (Dollars)`), 
                               `Bottle Volume (ml)` = mean(`Bottle Volume (ml)`),
                               `State Bottle Cost` = sum(`State Bottle Cost`),
                               `State Bottle Retail` = sum(`State Bottle Retail`),
                               `Sale (Dollars)` = sum(`Sale (Dollars)`),
                               `Volume Sold (Gallons)` = sum(`Volume Sold (Gallons)`)) %>%
                    as_tibble()

iowa_data_reduced <- iowa_data_reduced %>%
                    dplyr::ungroup() %>%
                    mutate(Month = as.numeric(Month),
                           Year = as.numeric(Year),
                           `Category Name`= factor(`Category Name`)) %>%
                    arrange(Year, Month, County, City)

write.csv(iowa_data_reduced, "iowa_data_reduced.csv")
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE}
iowaDataReduced <- fread("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Final%20Project/iowa_data_reduced.csv", showProgress = FALSE) 
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE}
library(magrittr)
library(dplyr)

iowaDataReducedTop <- iowaDataReduced %>%
                      dplyr::group_by(Year, Category.Name) %>%
                      dplyr::select(Year, Category.Name, Volume.Sold..Gallons. ) %>%
                      dplyr::summarize(Volume.Sold..Gallons. = round(sum(Volume.Sold..Gallons.))) %>%
                      dplyr::top_n(n = 10, wt = Volume.Sold..Gallons.)

top10in2015 <- iowaDataReducedTop %>%
               dplyr::filter(Year == 2015)

top20counties <- iowaDataReduced %>%
                  dplyr::filter(Year == 2015) %>% 
                      dplyr::group_by(Year, County) %>%
                      dplyr::select(Year, Category.Name, Volume.Sold..Gallons. ) %>%
                      dplyr::summarize(Volume.Sold..Gallons. = sum(Volume.Sold..Gallons.)) %>%
                      top_n(n = 20, wt = Volume.Sold..Gallons.)
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE}
library(magrittr)

iowaDataReduced <- iowaDataReduced %>%
                   filter(Year == 2015) %>%
                   dplyr::select(County, Category.Name, 
                                 Bottles.Sold, Sale..Dollars., Volume.Sold..Gallons.) %>%
                  mutate(`Price per Bottle` = Sale..Dollars./Bottles.Sold) %>%
                   dplyr::group_by(County, Category.Name) %>%
                   dplyr::summarize(`Bottles Sold` = sum(Bottles.Sold), 
                             `Avg Price Per Bottle` = mean(`Price per Bottle`),
                             `Sales in Dollars` = sum(Sale..Dollars.), 
                             `Volume Sold by Gallons` = sum(Volume.Sold..Gallons.)) %>%
                  filter(County != "") %>%
                  filter(Category.Name %in% top10in2015$Category.Name) %>%
                  filter(County %in% top20counties$County)
```

```{r, echo = FALSE, eval=FALSE}
write.csv(iowaDataReduced, "iowa_data_reduced.csv")
```

We reviewed the liquor sales by gallons sold per year by Liquor Category. Initially, we viewed the top 5 Liquor Categories by volume sold but there were large disparities between years, suggesting that the top 5 change often and is likely due to changing consumer tastes. We do see a more stable set of liquor categories for the top 10 category which suggests that while tastes may change we don't see large movements in liquor categories at this level. We focused our attention on the whiskey categories.  

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=3.75, fig.width=10, eval=TRUE}
ggplot(iowaDataReducedTop, aes(x = Category.Name, y = Volume.Sold..Gallons., fill = factor(Year))) + 
      scale_y_continuous(labels = scales::comma) + 
      geom_bar(stat = "identity") +
      facet_grid(~Year) +
      theme_minimal() + 
      theme(axis.text.x = element_text(angle = 70, hjust = 1), legend.position = "none") + 
      coord_flip() + 
      xlab("Liquor Category") + 
      ylab("Volume Sold by Gallons\n") +
      ggtitle("Volume of Liquor Category Sales by Gallons Sold")
```

\newpage

We can further see that Des Moines accounts for a significant portion of the liquor sales in Polk County. Polk County is the most populous county in Iowa so we will limit our analysis to this city.

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, eval=FALSE}

iowaCounties   <- iowa_data %>%
                     dplyr::select(Date, City, County, `Category Name`, `Store Number`, `Store Name`, `Pack`, 
                            `Item Number`, `Item Description`, `Bottle Volume (ml)`, 
                            `State Bottle Cost`, `State Bottle Retail`, `Sale (Dollars)`,
                             `Volume Sold (Gallons)`, `Bottles Sold`) %>%
                    mutate(Date = as.Date(Date, format = "%m/%d/%Y"),
                           City = factor(toupper(City)),
                           County = factor(toupper(County)),
                           `Category Name` = factor( toupper(`Category Name`)),
                           `Store Number` = factor(`Store Number`),
                           `Store Name` = factor(`Store Name`), 
                           `Pack` = as.integer(`Pack`),
                           `Bottle Volume (ml)` = as.numeric(`Bottle Volume (ml)`), 
                           `State Bottle Cost` = removeDollars(`State Bottle Cost`), 
                           `State Bottle Retail` = removeDollars(`State Bottle Retail`), 
                           `Sale (Dollars)` = removeDollars(`Sale (Dollars)`),
                           `Volume Sold (Gallons)` = as.numeric(`Volume Sold (Gallons)`), 
                           `Bottles Sold` = as.integer(`Bottles Sold`)) %>%
                    mutate(Month = format(Date, "%m"),
                           Year = format(Date, "%Y")) %>%
                    dplyr::filter(grepl("WHISKIES", `Category Name`)) %>%
                    dplyr::select(-Date) %>%
                    group_by(Month, Year, City, County, `Category Name`, `Store Number`, `Store Name`)  %>%
                    summarize( `Pack` = mean(`Pack`),
                               `Bottles Sold` = sum(`Bottles Sold`), 
                               `Sale (Dollars)` = sum(`Sale (Dollars)`), 
                               `Bottle Volume (ml)` = mean(`Bottle Volume (ml)`),
                               `State Bottle Cost` = sum(`State Bottle Cost`),
                               `State Bottle Retail` = sum(`State Bottle Retail`),
                               `Sale (Dollars)` = sum(`Sale (Dollars)`),
                               `Volume Sold (Gallons)` = sum(`Volume Sold (Gallons)`)) %>%
                    as_tibble()

write.csv(iowaCounties, "iowaCounties.csv")
```

```{r echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, eval=TRUE}
iowaCounties <- fread("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Final%20Project/Final%20Project%20Markdown%20Folder/iowaCounties.csv", showProgress = FALSE)

iowaCounties <- iowaCounties %>% 
                ungroup() %>%
                mutate(County = factor(County),
                       City = factor(City)) %>% 
                dplyr::filter(!(County == '')) %>%
                select(Year, County, City, `Volume Sold (Gallons)`) %>%
                group_by(Year, County, City) %>%
                summarize(`Volume Sold (Gallons)` = sum(`Volume Sold (Gallons)`))
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=4.05, fig.width=10, eval=TRUE}
iowaCountiesPolk <- iowaCounties %>% filter(County == "POLK")

numberColors <- length(unique(iowaCountiesPolk$City))
ColorPalette <- colorRampPalette(brewer.pal(9, "Spectral"))

ggplot(iowaCounties %>% filter(County == "POLK"), aes(x = County, y = `Volume Sold (Gallons)`, fill = City)) + 
      scale_y_continuous(labels = scales::comma) + 
      geom_bar(stat = "identity") +
      scale_fill_manual(values = ColorPalette(numberColors)) + 
      facet_grid(~Year) +
      theme_minimal() + 
      theme(axis.text.x = element_text(angle = 70, hjust = 1)) + 
      guides(fill = guide_legend(keywidth = 2, keyheight = .75)) + 
      xlab("County") + 
      ylab("Volume Sold by Gallons\n") +
      ggtitle("Gallons Sold for all whiskey categories for each City in Polk County")
```

### Model Development  

### Bottles Sold Model   

We used forward selection method for our initial model for the Bottles Sold. However, we expect some high degrees of multicollinearity as some of our variables can be easily explained by other variables in the data set. We see a very high degree of multicollinearity in our independent variables for Bottles Sold and with good reason. If more bottles sold then certainly the volume sold by gallons would increase as would the sale dollars, we therefore removed volume sold by gallons. Below is the table that highlights the high levels of multicollinearity for Volume Sold by Gallons and Sale Dollars.  

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, eval=TRUE}
dfLiquorSales <- read.csv("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Final%20Project/iowa_data_reduced%2012.10.2016.csv") %>% mutate(Store.Number = factor(Store.Number))
```

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, eval=TRUE}
#Forward step 
forward <- step(lm(Bottles.Sold~1,data=dfLiquorSales),direction = "forward",
               scope=~Category.Name+Pack+Sale..Dollars.+Bottle.Volume..ml.
               +State.Bottle.Cost+State.Bottle.Retail+Volume.Sold..Gallons.,trace = FALSE)

fit1 <- lm(formula = Bottles.Sold ~ Volume.Sold..Gallons. + Category.Name + State.Bottle.Retail + 
             Pack + Sale..Dollars., data = dfLiquorSales)

dfVifFit <- setDT(as.data.frame(car::vif(fit1)), keep.rownames = TRUE)[]
dfVifFit$Adjusted_GVIF <- (dfVifFit$`GVIF^(1/(2*Df))`^2)
kable(dfVifFit, align = c("l", "c", "c", "c", "c"))
```

### Removing Influenctial points 

However, several values may have undue influence on the final form of our model. Using the `influencePlot` function from the `car` package and Cooks Distance plot, we can see which values that have the greatest impact on our model and we removed the observations indicated in the Cook's distance plot for 65, 70, and 227. We do see that the influenceplot function indicated observation 74, however, we chose to include this observation due to our comfort with the Cook's distance plot from Base R which did not indicate the same observation. 

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=3, fig.width=10}
fit1 <- lm(formula = Bottles.Sold ~ Volume.Sold..Gallons. + Category.Name + State.Bottle.Retail + 
             Pack, data = dfLiquorSales)

#Removal of influence points based on two methods
par(mfrow=c(1,2))

#1. influence points
x <- influencePlot(fit1)
pandoc.table(x, caption = "Influential points in Bottles Sold Model for influencePlot function")
#2. Cooks distance plot
plot(fit1,4)
stargazer(fit1, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Bottles Sold with Influencial Points")
```

Below are the diagnostic plots for our Model 1, without influential points. Unfortunately, we see a non-normal distribution in residuals of the qq plot and we see a linear relationship for the fitted and actual values plot. 

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, eval=TRUE}
#Remove the influential points and update the model

fit1 <- update(fit1, data=dfLiquorSales[c(-65,-70,-227),])
#predict(fit1,dfLiquorFit1,type = "response")
s.fit1 <- summary(fit1)
rmse <- sqrt(sum(fit1$residuals^2)/s.fit1$df[2])
#rmse = 31

par(mfrow = c(2,3))
x <- plot(fit1)
plot(fit1$model$Bottles.Sold, fit1$fitted.values, xlab = "Actual Values", ylab = "Fitted Values")

stargazer(fit1, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Bottles Sold without Influencial Points")
```

Our model has an extremely good Adjusted $R^2$ at 0.98 but we see that the distribution of the residuals is not normally distributed and the fitted values plotted to the actual values do show a clearly linear relationship. We will need to further transform the variables in order to have a more normal distribution of our residuals. We have an interesting correlation in that an increase in the Retail Price will have a .0723 increase in the number of bottles sold. The expectation would be that as retail price increases the number of bottles sold would decrease. 

### Bottles Sold Model with Log Transformation

Our adjusted model uses the same selection method of forward and keeps Bottles Sold as our dependent variable. However, we use the BoxCox transformation method to transform our dependent variable. The resulting $\lambda$ is 0 so our transformation is log. In using this selection method and dependent variable transformation, the final model excludes the Sales Dollars variable. Additionally, we have high multicollinearity between the Bottle Cost and the Retail variables, which is intuitive because Bottle Cost has a high impact on Retail price. We remove the Bottle Cost variable as we have more interest in the impacts Retail Price may have on our dependent variable. 

```{r data read, echo = FALSE, cache=TRUE}
dfLiquorSales <- read.csv("https://raw.githubusercontent.com/ChristopheHunt/DATA-621-Group-1/master/Final%20Project/iowa_data_reduced%2012.10.2016.csv") %>% mutate(Store.Number = factor(Store.Number))
```

```{r forward, echo = FALSE, cache=TRUE, results='asis'}
forward <- step(lm(log(Bottles.Sold)~1,data=dfLiquorSales),direction = "forward",
                 scope=~Category.Name + Pack + Sale..Dollars. + Bottle.Volume..ml.
                 + State.Bottle.Cost + State.Bottle.Retail + Volume.Sold..Gallons.,trace = FALSE)

fit2 <- lm(formula = log(Bottles.Sold) ~ State.Bottle.Cost + Category.Name + 
             State.Bottle.Retail + Pack + Volume.Sold..Gallons. + Bottle.Volume..ml., 
           data = dfLiquorSales)

dfVifFit <- setDT(as.data.frame(car::vif(fit2)), keep.rownames = TRUE)[]
dfVifFit$Adjusted_GVIF <- (dfVifFit$`GVIF^(1/(2*Df))`^2)
kable(dfVifFit, align = c("l", "c", "c", "c", "c"))

fit2 <- lm(formula = log(Bottles.Sold) ~ Category.Name + 
             State.Bottle.Retail + Pack + Volume.Sold..Gallons. + Bottle.Volume..ml., 
           data = dfLiquorSales)
stargazer(fit2, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Log Bottles Sold with Influencial Points")
```

We select the values that have the greatest influence on our model and remove them to improve the model performance. The observations removed in this model is 70, 229, 272. We excluded 272 as indicated in the Cook's distance plot from Base R. By excluding these values from our evaluation data set we are able to fit a more appropriate model.

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=3.5, fig.width=10}
#Removal of influence points based on two methods
par(mfrow=c(1,2))
#1. influence points
influence <- influencePlot(fit2)
pandoc.table(influence, caption = "Influential points in Log of Bottles Sold Model from influencePlot function")
#2. Cooks distance plot
cook <- plot(fit2,4)
```

\newpage

We further examine our diagnostic plots for our first model with the log transformation. 

```{r, echo = FALSE, cache=TRUE, results='asis'}
#Remove the influential points and update the model
fit2 <- update(fit2,data=dfLiquorSales[c(-70,-229, -272),])

stargazer(fit2, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Log of Bottles Sold without Influencial Points")
```

```{r, echo = FALSE, cache=TRUE, results='asis'}
par(mfrow=c(2,3))
x <- plot(fit2)
plot(fit2$model$`log(Bottles.Sold)`, fit2$fitted.values, xlab = "Actual Values", ylab = "Fitted Values")
```

\bigskip

The table of our detailed model is located in the Appendix and fortunately, we see a much more normal distribution of the residuals. Interestingly, our results show that one unit increase in the Retail will increase the log of bottles sold by .0032 units. We would expect a negative correlation with bottles price and bottles sold. Canadian whiskies, Irish Whiskies, and Scotch were shown to be the most significant but they do represent the majority of sales while Single Barrel Bourbon Whiskies and Straight Rye Whiskies are approaching significance. In comparison to Blended Whiskey, Canadian Whiskies will increase the log of bottles sold by 0.62, whereas, Irish Whiskies will decrease the log of bottles sold by 0.788 and Scotch will decrease the log of bottles sold by 0.71. 

Also, as expected, a unit increase in the Pack will increase the log of bottles sold by 0.058 units. Another interesting finding is that a unit increase in Bottle Volume will increase log of bottles sold by .0005 units, it would suggest that larger bottles are correlated with better sales. The Adjusted R^2 was improved from .588 to .631 by removing the influence points. Also, the AIC of this model is `r round(AIC(fit2),3)` which is a much better AIC than `r round(AIC(fit1),3)` from our non log previous model. 

\newpage

### Profit Dollars Model Development  

We now developed a model for the Profit Dollars for Whiskey sales in Des Moines. Profit Dollars is measured as the Retail Sale less the Cost of the liquor. We measure this value as pricing strategies are necessary in attempting to maximize profit will maintaining efficient inventory control. Using the forward selection method we find that the variables `Pack` and `Bottle Volume in ml` are not significant so they will be removed from our final model. 

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, eval=TRUE}
dfLiquorSales$ProfitDollar <- dfLiquorSales$State.Bottle.Retail - dfLiquorSales$State.Bottle.Cost
```

```{r bottles, echo = FALSE, cache=TRUE, results='asis'}
step <- step(lm(ProfitDollar~1,data = dfLiquorSales),direction = "forward",
             scope = ~Category.Name+Pack+Sale..Dollars.+Bottle.Volume..ml.
             + Volume.Sold..Gallons.,trace = FALSE)

fit3 <- lm(formula = ProfitDollar ~ Volume.Sold..Gallons. + Category.Name + 
     Sale..Dollars., data = dfLiquorSales)

stargazer(fit3, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Profit Dollars with Influencial Points")
```

We further remove the influential points that are outliers as we did in our previous model by the observations illustrated by our influence plot and Cooks distance plot. 

```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=3.5, fig.width=10}
#Removal of influence points based on two methods
#1. influence points
par(mfrow=c(1,2))
x <- influencePlot(fit3)
pandoc.table(x, caption = "Influential points in Profit Dollars Model")
#2. Cooks distance plot
plot(fit3,4)
```

```{r, echo = FALSE, cache=TRUE, results='asis', warning=FALSE, message=FALSE}
#Remove the influential points and update the model
fit3 <- update(fit3,data=dfLiquorSales[c(-70,-229),])
par(old.par)
par(mfrow=c(2,3))
plot(fit3)
plot(fit3$fitted.values,fit3$model$ProfitDollar, xlab = "Actual Values", ylab = "Fitted Values" )
abline(fit3)
stargazer(fit3, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Profit Dollars without Influencial Points")

```


Again, we see that the distribution of the residuals is not normally distributed and the fitted values plotted to the actual values do show a clearly linear relationship. We will need to further transform the variables in order to have a more normal distribution of our residuals. In performing a Box Cox transformation on the dependent variable we find that the lambda value is close to 0 and we should therefore perform log transformation. 

### Profit Dollars Log Model

The forward selection method removed the variable Pack from our final model. 

```{r, echo = FALSE, cache=TRUE, results='asis'}
step <- step(lm(log(ProfitDollar)~1,data = dfLiquorSales),direction = "forward",
             scope = ~Category.Name+Pack+Sale..Dollars.+Bottle.Volume..ml.
             + Volume.Sold..Gallons.,trace = FALSE)

fit4 <- lm(formula =  log(ProfitDollar) ~ Volume.Sold..Gallons. + Category.Name + 
    Sale..Dollars. + Bottle.Volume..ml., data = dfLiquorSales)

stargazer(fit4, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model for Log of Profit Dollars with Influencial Points")
```

We further remove the influential points that are outliers as we did in our previous model by the observations illustrated by our influence plot and Cooks distance plot. 
```{r, echo = FALSE, results='asis', warning = FALSE, message = FALSE, cache=TRUE, fig.height=3.5, fig.width=10}
#Removal of influence points based on two methods
#1. influence points
par(mfrow=c(1,2))
x <- influencePlot(fit4)
pandoc.table(x, caption = "Influential points in Log Profit Dollars Model")
#2. Cooks distance plot
plot(fit4,4)
```

```{r, echo = FALSE, cache=TRUE, results='asis', warning=FALSE, message=FALSE}
#Remove the influential points and update the model
fit4 <- update(fit4, data = dfLiquorSales[c(-70,-115,-189),])
par(mfrow=c(2,3))
plot(fit4)
plot(fit4$fitted.values,fit4$model$ProfitDollar, xlab = "Actual Values", ylab = "Fitted Values" )

stargazer(fit4, header = FALSE, no.space = TRUE, style = "all2", font.size = "normalsize", single.row = TRUE, intercept.bottom = FALSE, title = "Forward Selection Linear Model Log Profit Dollars without Influencial Points")
```

The table of our detailed model for log Profit Dollars is located in the Appendix and fortunately, we see a much more normal distribution of the residuals. Interestingly, our results show that one unit increase in the Bottle Volume will increase the log of Profit dollars by .0004 units. In this model all Whiskies were shown to be significant  and in comparison to Blended Whiskey, Canadian Whiskies will increase the log of Profit Dollars by 1.171, whereas, Irish Whiskies will only increase the log of profit dollars by .707. None of the whiskies will reduce the log of profit dollars. 

Also, unexpectedly, a unit increase in the Sale Dollars will decrease the log of profit dollars by 0.05 units. This is intuitive however, because to increase sales we may have to reduce retail price and therefore reduce our profit dollars. The Adjusted R^2 for this model was increased from .347 to .410 by removing the influencial points. Also, the AIC of this model is `r round(AIC(fit4),3)` which is a much better than the AIC of the non log transformed model at `r round(AIC(fit3),3)`.  

Discussion and Conclusions
============================

The resulting models allow us to model for November in Des Moines for both Bottles Sold and Profit Dollars. We can utilize a naive forecast, assuming that the prior year of 2015 is predictive of the year 2016. However, there are further analysis types that may result in more robust predictions. 

In one study involving pharmaceutical distribution companies, the purpose was to propose a novel method to forecast the sales of the companies. Network-based analysis was conducted to find clique sets and group members and to use the sales data of comembers. The reason for this was the lack of sufficient historic sales records of each drug (@Pharma2)

Three methods were used to build time series models forecasting sales - ARIMA methodology, neural network, and an advanced hybrid neural network approach. The performance of the proposed method was evaluated using a real data set provided by one of the leading pharmacy distribution companies in Iran. The results of the evaluation indicated that the proposed method can cope with the low number of past records while accurately forecasting medicine sales. An evaluation of the liquor data set using these techniques may provide greater insight as the vast number of records could produce a more accurate model (@Pharma2). 

After exploratory analysis was done on the data, it was concluded that most medicines had different and specific characteristics and sales behavior, it was impractical to make a single prediction model for all medicines, and most sales records had nonlinear relationships. This may suggest that it would be more beneficial to model liquor categories individually. However, the reason why the hybrid neural network method was carried out was due to the fact that it is not acceptable to apply a fully linear or nonlinear model on sales data. The two forecast error measures that were used to evaluate and compare model performance were mean squared error and mean absolute error. The performance of the predicted data was significantly improved when the past records of comembers were used (@Pharma2). 

The other study that examined prediction-based inventory optimization using data mining models, the Back propagation neural network was used for training the prediction model. The idea that gave rise to this method of inventory prediction was the idea that the demand of marketing is viewed as the foundation of inventory management. On the basis of the prediction result, a simple and concise inventory policy was established. Following this, the historic sales data was used to estimate a normal distribution of demand and to calculate the inventory cost with inventory strategy (@DataMining1).

Two models (Back Propagation Neural Network and Support Vector Regression) were established using three input variables (historical sales data, the frequency of searching the commodity, and the click volume of the commodity page). When the back-propagation neural network method was used, there was more accuracy shown in the performance because the predicted values almost matched the actual values in the graphs. This suggests that our Naive Forecast approach could be improved through the use of theses techniques in conjunction with historical sales to create a more robust model (@DataMining1)

In another study conducted in 2012 in Idaho, the monthly revenue generated was examined rather than the yearly revenue generated. Which is in line with our model approach for using a single month rather than a year. The continued growth was rather owed to the number of weekends a month has (five instead of four) and to the higher prices in neighboring states. In Washington, the voters approved an initiative that led the state to sell its liquor stores and add new distributor and retail fees, making prices in the neighboring states (Idaho and Oregon) look better. There were no changes made in marketing or pricing in response to the regulatory shift in Washington @IdahoSales4. Further research into the proximity of our counties to states and towns with higher prices and regulation may provide more insight into sales and volume of liquor sold. Additionally, reviewing the data by identifying months that has 5 weekends instead of four could provide further insights. A follow up study on how prices may have been impacted by pricing strategies in neighboring states and the number of weekends per month may offer further insights and improve the approach taken in this analysis. 

\newpage

Appendices
=============

# AIC Value Comparison

```{r, results='asis', echo=FALSE}
x <- c(round(AIC(fit1),3), round(AIC(fit2),3), round(AIC(fit3),3), round(AIC(fit4),3))
y <- c("Bottles Sold", "Log Bottles Sold", "Profit Dollars", "Log of Profit Dollars")
z <- cbind(y,x)
colnames(z) <- c("Model Name", "AIC")
pandoc.table(z, caption = "AIC Values")
```


# Supplemental tables and figures.

```{r data set decsribed, results='asis', echo=FALSE}
dfLiquorSales <- dfLiquorSales %>% select(-X)
describedData <- describe(dfLiquorSales)
latex(describedData, file = '')
```

```{r, results='asis', echo=FALSE, eval=FALSE}
Store.Names <- gsub("#", "", as.character(abbreviate(dfLiquorSales$Store.Name)))
latex(describe(Store.Names), file = '')
latex(describe(dfLiquorSales$Store.Number), file = '')
latex(describe(dfLiquorSales$Category.Name), file = '')
```

# Session Info

```{r, results='asis', echo=FALSE, eval = TRUE}
toLatex(sessionInfo())
```

# R statistical programming code.

Please see [Final Project.rmd](https://github.com/ChristopheHunt/DATA-621-Group-1/blob/master/Final%20Project/Final%20Project.Rmd) on GitHub for source code.   

https://github.com/ChristopheHunt/DATA-621-Group-1/blob/master/Final%20Project/Final%20Project.Rmd

\newpage
References {#references .unnumbered}
===============

